# PowerShell 7+ recommended

# Function to safely export Chrome/Edge saved passwords
function Get-SavedPasswords {
    param(
        [string]$Browser = "Chrome"  # Can be Chrome or Edge
    )

    $userDataPath = switch ($Browser) {
        "Chrome" { "$env:LOCALAPPDATA\Google\Chrome\User Data\Default" }
        "Edge"   { "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default" }
        default  { Write-Host "Unsupported browser"; return }
    }

    $loginData = Join-Path $userDataPath "Login Data"

    if (-not (Test-Path $loginData)) {
        Write-Host "No saved passwords found for $Browser"
        return
    }

    # Copy the DB to avoid file lock
    $tempDB = Join-Path $env:TEMP "$Browser-LoginData.db"
    Copy-Item $loginData $tempDB -Force

    # Load SQLite
    Add-Type -Path "$env:USERPROFILE\.nuget\packages\system.data.sqlite.core\*\lib\netstandard2.0\System.Data.SQLite.dll"

    $conn = New-Object System.Data.SQLite.SQLiteConnection "Data Source=$tempDB;Version=3;"
    $conn.Open()

    $cmd = $conn.CreateCommand()
    $cmd.CommandText = "SELECT origin_url, username_value, password_value FROM logins"
    $reader = $cmd.ExecuteReader()

    while ($reader.Read()) {
        $url = $reader["origin_url"]
        $username = $reader["username_value"]
        $encryptedPassword = $reader["password_value"] -as [byte[]]

        # Decrypt using Windows DPAPI
        try {
            $password = [System.Text.Encoding]::UTF8.GetString(
                [System.Security.Cryptography.ProtectedData]::Unprotect(
                    $encryptedPassword, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser
                )
            )
        } catch {
            $password = "Could not decrypt"
        }

        [PSCustomObject]@{
            URL      = $url
            Username = $username
            Password = $password
        }
    }

    $reader.Close()
    $conn.Close()
    Remove-Item $tempDB
}

# Example usage: fetch Chrome passwords
$chromePasswords = Get-SavedPasswords -Browser "Chrome"
$chromePasswords | Format-Table -AutoSize

# Example usage: fetch Edge passwords
#$edgePasswords = Get-SavedPasswords -Browser "Edge"
#$edgePasswords | Format-Table -AutoSize

