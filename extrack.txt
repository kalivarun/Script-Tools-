# PowerShell script to fetch usernames and passwords from installed browsers without dependencies
Write-Host "Fetching usernames and passwords from installed browsers..." -ForegroundColor Green

# Define browsers and their user data paths
$browsers = @{
    "Google Chrome" = @{
        DataPath = "$env:LocalAppData\Google\Chrome\User Data"
        RegistryName = "Google Chrome"
    }
    "Brave" = @{
        DataPath = "$env:LocalAppData\BraveSoftware\Brave-Browser\User Data"
        RegistryName = "Brave"
    }
    "Microsoft Edge" = @{
        DataPath = "$env:LocalAppData\Microsoft\Edge\User Data"
        RegistryName = "Microsoft Edge"
    }
}

# Initialize counter for total browsers found
$totalBrowsers = 0

# Function to check if browser is installed via registry
function Test-BrowserInstalled {
    param (
        [string]$regPath,
        [string]$browserName
    )

    try {
        if (Test-Path $regPath) {
            $apps = Get-ItemProperty -Path $regPath -ErrorAction SilentlyContinue
            foreach ($app in $apps) {
                if ($app.DisplayName -like "*$browserName*" -and $app.DisplayName -notlike "*WebView*") {
                    Write-Host "Found $browserName in registry: $regPath" -ForegroundColor Yellow
                    return $true
                }
            }
        }
        return $false
    } catch {
        Write-Host "Error checking registry $regPath - $_" -ForegroundColor Red
        return $false
    }
}

# Function to run ChromePass and fetch passwords
function Get-PasswordsFromDatabase {
    param (
        [string]$dbPath,
        [string]$browser,
        [string]$chromePassPath
    )

    if (-not (Test-Path $dbPath)) {
        Write-Host "$browser database not found - $dbPath" -ForegroundColor Red
        return
    }

    try {
        Write-Host "Running ChromePass for $browser on $dbPath" -ForegroundColor Yellow
        # Run ChromePass with command-line options to extract passwords in CSV format
        $output = & $chromePassPath /scomma /external $dbPath
        Write-Host "`nPasswords for $browser" -ForegroundColor Cyan
        Write-Host "----------------------------------------"
        $found = $false

        # Parse ChromePass output (CSV format)
        $lines = $output -split "`n"
        foreach ($line in $lines) {
            if ($line -match '^"([^"]+)","([^"]*)","([^"]*)","([^"]*)","([^"]*)","([^"]*)"') {
                $url = $matches[1]
                $username = $matches[3]
                $password = $matches[4]
                if ($username -and $password) {
                    Write-Host "Website: $url"
                    Write-Host "Username: $username"
                    Write-Host "Password: $password"
                    Write-Host "----------------------------------------"
                    $found = $true
                }
            }
        }

        if (-not $found) {
            Write-Host "No passwords found in $dbPath" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "Error accessing $dbPath for $browser - $_" -ForegroundColor Red
    }
}

# Verify ChromePass.exe exists
$chromePassPath = "C:\Users\ksvar\OneDrive\Desktop\Powershell\ChromePass.exe"
if (-not (Test-Path $chromePassPath)) {
    Write-Host "Error: ChromePass.exe not found in C:\Users\ksvar\OneDrive\Desktop\Powershell. Please download from https://www.nirsoft.net/utils/chromepass.html and place it there." -ForegroundColor Red
    Write-Host "Press Enter to exit..." -ForegroundColor Yellow
    Read-Host
    exit
}

# Registry paths for installed programs (32-bit and 64-bit)
$registryPaths = @(
    "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*"
)

# Check installed browsers and fetch passwords
foreach ($browser in $browsers.Keys) {
    $isInstalled = $false
    foreach ($path in $registryPaths) {
        if (Test-BrowserInstalled -regPath $path -browserName $browsers[$browser].RegistryName) {
            $isInstalled = $true
            break
        }
    }

    if ($isInstalled) {
        $script:totalBrowsers++
        Write-Host "`nProcessing $browser..." -ForegroundColor Green

        # Check Default profile
        $loginDataPath = Join-Path $browsers[$browser].DataPath "Default\Login Data"
        $loginDataAccountPath = Join-Path $browsers[$browser].DataPath "Default\Login Data For Account"

        Get-PasswordsFromDatabase -dbPath $loginDataPath -browser "$browser (Local)" -chromePassPath $chromePassPath
        Get-PasswordsFromDatabase -dbPath $loginDataAccountPath -browser "$browser (Synced)" -chromePassPath $chromePassPath

        # Check for additional profiles (e.g., Profile 1, Profile 2)
        $userDataPath = $browsers[$browser].DataPath
        if (Test-Path $userDataPath) {
            $profiles = Get-ChildItem -Path $userDataPath -Directory | Where-Object { $_.Name -like "Profile *" }
            foreach ($profile in $profiles) {
                $profileLoginDataPath = Join-Path $profile.FullName "Login Data"
                $profileLoginDataAccountPath = Join-Path $profile.FullName "Login Data For Account"
                Get-PasswordsFromDatabase -dbPath $profileLoginDataPath -browser "$browser ($($profile.Name) - Local)" -chromePassPath $chromePassPath
                Get-PasswordsFromDatabase -dbPath $profileLoginDataAccountPath -browser "$browser ($($profile.Name) - Synced)" -chromePassPath $chromePassPath
            }
        }
    } else {
        Write-Host "Browser $browser not found in registry" -ForegroundColor Red
    }
}

# Final output
Write-Host "`nTotal browsers with data processed: $totalBrowsers" -ForegroundColor Yellow
Write-Host "Note: Passwords are decrypted for display only. No data has been saved to disk." -ForegroundColor Yellow
Write-Host "To access passwords later, use NirSoft ChromePass or restore to a working browser." -ForegroundColor Yellow

# Pause to keep console open
Write-Host "Press Enter to exit..." -ForegroundColor Yellow
Read-Host
